<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HRIS â€” HR Information System</title>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Exo+2:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --sb:#0d1b2a;--sb-h:#162a3e;--sb-a:#1a3349;--sb-b:#1c3148;
  --ac:#00b4d8;--ac2:#0096c7;--ac-g:rgba(0,180,216,.13);
  --hd:#0f2030;--bg:#eef2f7;--wh:#fff;
  --t1:#1a2533;--t2:#4a5568;--t3:#718096;
  --br:#e2e8f0;--th:#1e3a52;--ta:#f7fafc;
  --red:#e53e3e;--grn:#38a169;--org:#d97706;
  --sw:252px;
}
body{font-family:'Exo 2',sans-serif;background:var(--bg);color:var(--t1);display:flex;min-height:100vh}

/* â”€â”€â”€ SIDEBAR â”€â”€â”€ */
#sb{width:var(--sw);min-height:100vh;background:var(--sb);display:flex;flex-direction:column;position:fixed;top:0;left:0;z-index:100;border-right:1px solid var(--sb-b);overflow-y:auto}
.sb-logo{padding:24px 20px 18px;border-bottom:1px solid var(--sb-b);text-align:center}
.sb-logo .lt{font-family:'Rajdhani',sans-serif;font-size:1.55em;font-weight:700;color:var(--ac);letter-spacing:3px;display:block;line-height:1}
.sb-logo .ls{font-size:.67em;color:#7fa5c0;letter-spacing:1.5px;text-transform:uppercase;margin-top:4px;display:block}
.sb-lbl{font-size:.6em;text-transform:uppercase;letter-spacing:2px;color:#35526a;padding:15px 20px 4px;font-weight:700}
nav ul{list-style:none;padding:3px 0}
nav ul li a{display:flex;align-items:center;gap:11px;padding:10px 20px;color:#8ab0c8;text-decoration:none;font-size:.87em;font-weight:500;transition:all .18s;border-left:3px solid transparent;cursor:pointer}
nav ul li a:hover{background:var(--sb-h);color:#c8e6f5;border-left-color:var(--ac)}
nav ul li a.active{background:var(--sb-a);color:var(--ac);border-left-color:var(--ac);box-shadow:inset 0 0 18px var(--ac-g)}
nav ul li a .ni{font-size:1.08em;width:21px;text-align:center}
.sb-foot{margin-top:auto;border-top:1px solid var(--sb-b);padding:10px 0}
.sb-foot a{display:flex;align-items:center;gap:11px;padding:9px 20px;color:var(--red);font-size:.85em;font-weight:600;cursor:pointer;transition:background .18s;text-decoration:none}
.sb-foot a:hover{background:rgba(229,62,62,.08)}

/* â”€â”€â”€ MAIN â”€â”€â”€ */
#main{margin-left:var(--sw);flex:1;display:flex;flex-direction:column;min-height:100vh}
#topbar{background:var(--hd);padding:12px 28px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #1a3348;position:sticky;top:0;z-index:50}
.tb-title{font-family:'Rajdhani',sans-serif;font-size:1.2em;font-weight:700;color:#c8e6f5;letter-spacing:1px}
.tb-meta{color:#5a8aaa;font-size:.78em}
.tb-right{display:flex;align-items:center;gap:10px}
#es{font-size:.75em;padding:3px 9px;border-radius:4px;font-weight:700}
.es-on{background:#c6f6d5;color:#1a4731}
.es-off{background:#fed7d7;color:#742a2a}
.tb-av{width:30px;height:30px;background:var(--ac);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:.78em}
#page{padding:24px 26px;flex:1}

/* â”€â”€â”€ STATS â”€â”€â”€ */
.sg{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:13px;margin-bottom:20px}
.sc{background:var(--wh);border:1px solid var(--br);border-radius:8px;padding:17px 14px;text-align:center;transition:box-shadow .2s,transform .2s}
.sc:hover{box-shadow:0 4px 14px rgba(0,0,0,.08);transform:translateY(-2px)}
.sc .sn{font-family:'Rajdhani',sans-serif;font-size:2.2em;font-weight:700;color:var(--ac2);line-height:1}
.sc .sl{font-size:.73em;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-top:4px;font-weight:600}
.sc .si{font-size:1.45em;margin-bottom:4px}

/* â”€â”€â”€ PANEL â”€â”€â”€ */
.panel{background:var(--wh);border:1px solid var(--br);border-radius:8px;margin-bottom:20px;overflow:hidden}
.ph{background:var(--th);color:#c8e6f5;padding:12px 18px;font-family:'Rajdhani',sans-serif;font-size:1em;font-weight:600;letter-spacing:.9px;display:flex;align-items:center;justify-content:space-between}
.pb{padding:20px}

/* â”€â”€â”€ TABLE â”€â”€â”€ */
.tw{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.86em}
thead th{background:var(--th);color:#8ab0c8;text-align:left;padding:9px 13px;font-weight:600;letter-spacing:.4px;text-transform:uppercase;font-size:.74em;white-space:nowrap}
tbody tr{border-bottom:1px solid var(--br);transition:background .13s}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:#f0f7fc}
tbody tr:nth-child(even){background:var(--ta)}
tbody tr:nth-child(even):hover{background:#e8f4fa}
td{padding:9px 13px;color:var(--t1);vertical-align:middle}
td.m{color:var(--t3)}
.nd{text-align:center;padding:36px;color:var(--t3);font-size:.87em}

/* â”€â”€â”€ BUTTONS â”€â”€â”€ */
.btn{display:inline-flex;align-items:center;gap:5px;padding:8px 15px;border:none;border-radius:5px;font-size:.82em;font-weight:600;cursor:pointer;transition:all .18s;font-family:'Exo 2',sans-serif;white-space:nowrap}
.bp{background:var(--ac);color:#fff}.bp:hover{background:var(--ac2);box-shadow:0 4px 12px rgba(0,180,216,.3)}
.bs{background:#e2e8f0;color:var(--t2)}.bs:hover{background:#cbd5e0}
.bd{background:var(--red);color:#fff}.bd:hover{background:#c53030}
.bg{background:var(--grn);color:#fff}.bg:hover{background:#2f855a}
.bo{background:transparent;border:1px solid var(--ac);color:var(--ac)}.bo:hover{background:var(--ac);color:#fff}
.bw{background:var(--org);color:#fff}.bw:hover{background:#b45309}
.bsm{padding:4px 9px;font-size:.76em}
.btn:disabled{opacity:.5;cursor:not-allowed}

/* â”€â”€â”€ SECTION HEADER â”€â”€â”€ */
.sh{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;padding-bottom:13px;border-bottom:2px solid var(--br)}
.sh-l h2{font-family:'Rajdhani',sans-serif;font-size:1.5em;font-weight:700;color:var(--t1)}
.sh-l p{color:var(--t3);font-size:.82em;margin-top:2px}
.sh-r{display:flex;gap:9px}

/* â”€â”€â”€ FORMS â”€â”€â”€ */
.fg{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.fg3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.fgrp{margin-bottom:13px}
.fgrp.full{grid-column:1/-1}
label{display:block;font-size:.77em;font-weight:700;color:var(--t2);margin-bottom:5px;text-transform:uppercase;letter-spacing:.4px}
input[type=text],input[type=email],input[type=date],input[type=month],input[type=number],input[type=file],select,textarea{width:100%;padding:8px 11px;border:1px solid var(--br);border-radius:5px;font-size:.89em;font-family:'Exo 2',sans-serif;color:var(--t1);background:#fff;transition:border-color .2s,box-shadow .2s}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--ac);box-shadow:0 0 0 3px var(--ac-g)}
textarea{resize:vertical;min-height:85px}
.cc{font-size:.73em;color:var(--t3);text-align:right;margin-top:3px}

/* â”€â”€â”€ BADGES â”€â”€â”€ */
.badge{display:inline-block;padding:2px 9px;border-radius:20px;font-size:.72em;font-weight:700;letter-spacing:.3px;text-transform:uppercase}
.bh{background:#c6f6d5;color:#1a4731}.be{background:#bee3f8;color:#1a365d}
.bpay{background:#feebc8;color:#7c2d12}.bother{background:#e9d8fd;color:#44337a}
.bon{background:#c6f6d5;color:#1a4731}.boff{background:#fed7d7;color:#742a2a}
.burg{background:#fed7d7;color:#742a2a}.bnorm{background:#bee3f8;color:#1a365d}
.binf{background:#c6f6d5;color:#1a4731}.bsent{background:#c6f6d5;color:#1a4731}
.bdraft{background:#e9d8fd;color:#44337a}

/* â”€â”€â”€ FILE DROP ZONE â”€â”€â”€ */
.fdz{border:2px dashed #cbd5e0;border-radius:8px;padding:22px;text-align:center;cursor:pointer;transition:all .2s;background:#fafcff}
.fdz:hover,.fdz.over{border-color:var(--ac);background:var(--ac-g)}
.fdz .fi{font-size:2em;margin-bottom:7px}
.fdz p{color:var(--t2);font-size:.85em}
.fdz .fh{font-size:.75em;color:var(--t3);margin-top:3px}
.fc{color:var(--ac2);font-weight:600;font-size:.85em;margin-top:7px}

/* â”€â”€â”€ ATTACHMENT CHIPS â”€â”€â”€ */
.att-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.att-chip{display:flex;align-items:center;gap:7px;background:#eef2f7;border:1px solid var(--br);border-radius:6px;padding:5px 10px;font-size:.8em;font-weight:600;color:var(--t2)}
.att-chip .att-name{max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.att-chip .att-rm{background:none;border:none;cursor:pointer;color:var(--red);font-size:1em;line-height:1;padding:0 2px}
.att-chip .att-icon{font-size:1.1em}

/* â”€â”€â”€ BROADCAST CARDS â”€â”€â”€ */
.bc-card{border-radius:8px;padding:16px 18px;margin-bottom:12px;position:relative;transition:box-shadow .2s}
.bc-card:hover{box-shadow:0 4px 14px rgba(0,0,0,.08)}
.bc-card.urgent{background:#fff5f5;border:1px solid #feb2b2;border-left:4px solid var(--red)}
.bc-card.normal{background:#ebf8ff;border:1px solid #90cdf4;border-left:4px solid var(--ac)}
.bc-card.info{background:#f0fff4;border:1px solid #9ae6b4;border-left:4px solid var(--grn)}
.bc-hd{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:9px;gap:10px}
.bc-title{font-weight:700;font-size:.97em;color:var(--t1)}
.bc-meta{font-size:.76em;color:var(--t3);margin-top:2px}
.bc-body{font-size:.87em;color:var(--t2);line-height:1.6;white-space:pre-line}
.bc-foot{display:flex;align-items:center;justify-content:space-between;margin-top:10px;padding-top:9px;border-top:1px solid rgba(0,0,0,.06)}
.rchips{display:flex;flex-wrap:wrap;gap:5px}
.rchip{background:rgba(0,0,0,.06);padding:2px 9px;border-radius:12px;font-size:.74em;color:var(--t2);font-weight:600}
.att-badge{display:inline-flex;align-items:center;gap:4px;background:rgba(0,0,0,.07);padding:3px 9px;border-radius:12px;font-size:.73em;font-weight:600;color:var(--t2)}

/* â”€â”€â”€ RECIPIENT SELECTOR â”€â”€â”€ */
.rsel{border:1px solid var(--br);border-radius:8px;overflow:hidden}
.rsel-hd{background:#f7fafc;padding:9px 13px;border-bottom:1px solid var(--br);display:flex;align-items:center;justify-content:space-between}
.rsel-hd span{font-size:.78em;font-weight:700;color:var(--t2);text-transform:uppercase;letter-spacing:.4px}
.rlist{max-height:190px;overflow-y:auto}
.rlist label{display:flex;align-items:center;gap:9px;padding:8px 13px;cursor:pointer;font-size:.86em;text-transform:none;letter-spacing:0;font-weight:500;color:var(--t1);border-bottom:1px solid #f0f4f8;transition:background .13s}
.rlist label:hover{background:#f0f7fc}
.rlist label:last-child{border-bottom:none}
.rlist input[type=checkbox]{width:15px;height:15px;cursor:pointer;accent-color:var(--ac);flex-shrink:0}
.dept-tag{font-size:.7em;color:var(--t3);margin-left:auto}

/* â”€â”€â”€ PROGRESS â”€â”€â”€ */
.prog-wrap{background:#ebf8ff;border:1px solid #90cdf4;border-radius:8px;padding:14px 16px;margin-bottom:14px;display:none}
.prog-wrap.on{display:block}
.prog-bar-bg{background:#e2e8f0;border-radius:20px;height:7px;overflow:hidden;margin:7px 0}
.prog-bar{height:100%;background:linear-gradient(90deg,var(--ac),var(--ac2));border-radius:20px;transition:width .35s ease}
.prog-top{display:flex;justify-content:space-between;margin-bottom:4px}
.prog-lbl{font-size:.84em;font-weight:700;color:#1a365d}
.prog-cnt{font-size:.84em;color:var(--t2)}

/* â”€â”€â”€ ALERT â”€â”€â”€ */
.alert{padding:11px 15px;border-radius:6px;font-size:.85em;margin-bottom:14px;display:flex;align-items:flex-start;gap:9px;font-weight:500;line-height:1.5}
.ai{background:#ebf8ff;color:#1a365d;border:1px solid #90cdf4}
.as{background:#f0fff4;color:#1a4731;border:1px solid #9ae6b4}
.aw{background:#fffbeb;color:#7c2d12;border:1px solid #fcd34d}
.aD{background:#fff5f5;color:#742a2a;border:1px solid #feb2b2}

/* â”€â”€â”€ EMAIL PREVIEW â”€â”€â”€ */
.ep{background:#f7fafc;border:1px solid var(--br);border-radius:6px;padding:15px;margin-top:10px}
.ep-from{font-size:.75em;color:var(--t3);margin-bottom:3px}
.ep-sub{font-weight:700;color:var(--t1);margin-bottom:9px;padding-bottom:8px;border-bottom:1px solid var(--br)}
.ep-body{font-size:.86em;color:var(--t2);white-space:pre-line;line-height:1.65}

/* â”€â”€â”€ ACTIVITY â”€â”€â”€ */
.act-item{display:flex;gap:11px;padding:10px 0;border-bottom:1px solid var(--br);align-items:flex-start}
.act-item:last-child{border-bottom:none}
.act-dot{width:8px;height:8px;background:var(--ac);border-radius:50%;margin-top:5px;flex-shrink:0}
.act-text{font-size:.85em;color:var(--t1);flex:1}
.act-time{font-size:.74em;color:var(--t3);white-space:nowrap}

/* â”€â”€â”€ TOAST â”€â”€â”€ */
#tw{position:fixed;top:18px;right:22px;z-index:9999;display:flex;flex-direction:column;gap:9px}
.toast{background:#1e3a52;color:#c8e6f5;padding:11px 18px;border-radius:6px;font-size:.86em;font-weight:600;border-left:4px solid var(--ac);box-shadow:0 8px 22px rgba(0,0,0,.28);animation:tin .28s ease;max-width:330px}
.toast.err{border-left-color:var(--red)}.toast.ok{border-left-color:var(--grn)}
@keyframes tin{from{opacity:0;transform:translateX(36px)}to{opacity:1;transform:none}}

/* â”€â”€â”€ MODAL â”€â”€â”€ */
.mo{display:none;position:fixed;inset:0;background:rgba(5,14,26,.72);z-index:200;align-items:center;justify-content:center}
.mo.open{display:flex}
.mb{background:var(--wh);border-radius:10px;width:90%;max-width:700px;max-height:90vh;overflow-y:auto;box-shadow:0 24px 60px rgba(0,0,0,.45)}
.mh{background:var(--th);color:#c8e6f5;padding:14px 20px;font-family:'Rajdhani',sans-serif;font-size:1.1em;font-weight:700;letter-spacing:.9px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0}
.mbody{padding:22px}
.cx{background:none;border:none;color:#8ab0c8;font-size:1.45em;cursor:pointer;line-height:1}
.cx:hover{color:#fff}

/* â”€â”€â”€ SETTINGS CARD â”€â”€â”€ */
.code-block{background:#1e3a52;border-radius:8px;padding:16px;margin:12px 0;font-size:.82em}
.code-block code{color:#a8d5ea;line-height:2;display:block}
.code-block .v{color:#ffd57e}

.page-sec{display:none}.page-sec.active{display:block}
.hidden{display:none!important}

@media(max-width:820px){.fg,.fg3{grid-template-columns:1fr}.sg{grid-template-columns:repeat(2,1fr)}#sb{width:60px}.sb-logo .lt{font-size:0}.sb-logo .ls,.sb-lbl{display:none}nav ul li a span:not(.ni){display:none}#main{margin-left:60px}#page{padding:14px 12px}}
</style>
</head>
<body>

<!-- â•â•â• SIDEBAR â•â•â• -->
<aside id="sb">
  <div class="sb-logo">
    <span class="lt">HRIS</span>
    <span class="ls">HR Information System</span>
  </div>
  <nav>
    <div class="sb-lbl">Main</div>
    <ul>
      <li><a class="active" onclick="pg('dashboard',this)"><span class="ni">ğŸ“Š</span><span>Dashboard</span></a></li>
      <li><a onclick="pg('employees',this)"><span class="ni">ğŸ‘¥</span><span>Employees</span></a></li>
    </ul>
    <div class="sb-lbl">Records</div>
    <ul>
      <li><a onclick="pg('health',this)"><span class="ni">ğŸ¥</span><span>Health Records</span></a></li>
      <li><a onclick="pg('education',this)"><span class="ni">ğŸ“</span><span>Education & Training</span></a></li>
      <li><a onclick="pg('documents',this)"><span class="ni">ğŸ“</span><span>All Documents</span></a></li>
    </ul>
    <div class="sb-lbl">Payroll</div>
    <ul>
      <li><a onclick="pg('payslips',this)"><span class="ni">ğŸ’°</span><span>Payslips</span></a></li>
      <li><a onclick="pg('payhistory',this)"><span class="ni">ğŸ“œ</span><span>Send History</span></a></li>
    </ul>
    <div class="sb-lbl">Communications</div>
    <ul>
      <li><a onclick="pg('broadcast',this)"><span class="ni">ğŸ“¢</span><span>Broadcast Messages</span></a></li>
      <li><a onclick="pg('msghistory',this)"><span class="ni">ğŸ’¬</span><span>Message History</span></a></li>
    </ul>
    <div class="sb-lbl">Admin</div>
    <ul>
      <li><a onclick="pg('settings',this)"><span class="ni">âš™ï¸</span><span>Email Settings</span></a></li>
    </ul>
  </nav>
  <div class="sb-foot"><a onclick="clearAll()">ğŸšª Clear All Data</a></div>
</aside>

<!-- â•â•â• MAIN â•â•â• -->
<div id="main">
  <div id="topbar">
    <div>
      <div class="tb-title" id="tt">Dashboard</div>
      <div class="tb-meta" id="tm">Human Resources Overview</div>
    </div>
    <div class="tb-right">
      <div id="es" class="es-off">â— Email Offline</div>
      <div class="tb-av">CEO</div>
      <span style="color:#8ab0c8;font-size:.85em">Administrator</span>
    </div>
  </div>

  <div id="page">

    <!-- â•â•â• DASHBOARD â•â•â• -->
    <section id="sec-dashboard" class="page-sec active">
      <div class="sg">
        <div class="sc"><div class="si">ğŸ‘¥</div><div class="sn" id="s1">0</div><div class="sl">Employees</div></div>
        <div class="sc"><div class="si">ğŸ“„</div><div class="sn" id="s2">0</div><div class="sl">Documents</div></div>
        <div class="sc"><div class="si">ğŸ¥</div><div class="sn" id="s3">0</div><div class="sl">Health Records</div></div>
        <div class="sc"><div class="si">ğŸ“</div><div class="sn" id="s4">0</div><div class="sl">Certifications</div></div>
        <div class="sc"><div class="si">ğŸ’°</div><div class="sn" id="s5">0</div><div class="sl">Payslips Sent</div></div>
        <div class="sc"><div class="si">ğŸ“¢</div><div class="sn" id="s6">0</div><div class="sl">Broadcasts</div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
        <div class="panel">
          <div class="ph">ğŸ”” Recent Activity</div>
          <div class="pb" id="dash-act"><div class="nd">No activity yet</div></div>
        </div>
        <div class="panel">
          <div class="ph">âš¡ Quick Actions</div>
          <div class="pb" style="display:flex;flex-direction:column;gap:9px">
            <button class="btn bp" onclick="openModal('m-emp')">â• Add New Employee</button>
            <button class="btn bo" onclick="pg('broadcast')">ğŸ“¢ Send Broadcast Message</button>
            <button class="btn bo" onclick="pg('payslips')">ğŸ’° Send Monthly Payslips</button>
            <button class="btn bo" onclick="openUpload('health')">ğŸ¥ Upload Health Record</button>
            <button class="btn bo" onclick="openUpload('education')">ğŸ“ Upload Certification</button>
            <button class="btn bs" onclick="pg('settings')">âš™ï¸ Configure EmailJS</button>
          </div>
        </div>
      </div>
    </section>

    <!-- â•â•â• EMPLOYEES â•â•â• -->
    <section id="sec-employees" class="page-sec">
      <div class="sh"><div class="sh-l"><h2>ğŸ‘¥ Employees</h2><p>Manage your staff directory</p></div>
        <div class="sh-r"><button class="btn bp" onclick="openModal('m-emp')">â• Add Employee</button></div></div>
      <div class="panel"><div class="ph">Employee Directory</div>
        <div class="tw"><table><thead><tr><th>Name</th><th>ID</th><th>Department</th><th>Position</th><th>Email</th><th>Start Date</th><th>Docs</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="emp-tb"><tr><td colspan="9" class="nd">No employees yet</td></tr></tbody></table></div></div>
    </section>

    <!-- â•â•â• HEALTH â•â•â• -->
    <section id="sec-health" class="page-sec">
      <div class="sh"><div class="sh-l"><h2>ğŸ¥ Health Records</h2><p>Medical tests, screenings and health documentation</p></div>
        <div class="sh-r"><button class="btn bp" onclick="openUpload('health')">ğŸ“¤ Upload Health Record</button></div></div>
      <div class="panel"><div class="ph">Health Records</div>
        <div class="tw"><table><thead><tr><th>Title</th><th>Employee</th><th>Description</th><th>Uploaded</th><th>File</th><th>Actions</th></tr></thead>
        <tbody id="hlth-tb"><tr><td colspan="6" class="nd">No health records uploaded</td></tr></tbody></table></div></div>
    </section>

    <!-- â•â•â• EDUCATION â•â•â• -->
    <section id="sec-education" class="page-sec">
      <div class="sh"><div class="sh-l"><h2>ğŸ“ Education & Training</h2><p>Certifications, training records and qualifications</p></div>
        <div class="sh-r"><button class="btn bp" onclick="openUpload('education')">ğŸ“¤ Upload Certification</button></div></div>
      <div class="panel"><div class="ph">Education & Certifications</div>
        <div class="tw"><table><thead><tr><th>Title</th><th>Employee</th><th>Description</th><th>Uploaded</th><th>File</th><th>Actions</th></tr></thead>
        <tbody id="edu-tb"><tr><td colspan="6" class="nd">No certifications uploaded</td></tr></tbody></table></div></div>
    </section>

    <!-- â•â•â• ALL DOCS â•â•â• -->
    <section id="sec-documents" class="page-sec">
      <div class="sh"><div class="sh-l"><h2>ğŸ“ All Documents</h2><p>Complete document archive</p></div>
        <div class="sh-r"><button class="btn bp" onclick="openUpload('other')">ğŸ“¤ Upload Document</button></div></div>
      <div class="panel"><div class="ph">Document Archive</div>
        <div class="tw"><table><thead><tr><th>Title</th><th>Employee</th><th>Type</th><th>Description</th><th>Uploaded</th><th>Size</th><th>Actions</th></tr></thead>
        <tbody id="doc-tb"><tr><td colspan="7" class="nd">No documents uploaded</td></tr></tbody></table></div></div>
    </section>

    <!-- â•â•â• PAYSLIPS â•â•â• -->
    <section id="sec-payslips" class="page-sec">
      <div class="sh"><div class="sh-l"><h2>ğŸ’° Monthly Payslips</h2><p>Upload payslips and send automated emails to all staff</p></div>
        <div class="sh-r"><button class="btn bp" onclick="openUpload('payslip')">ğŸ“¤ Upload Payslip</button></div></div>

      <div class="panel">
        <div class="ph">ğŸ“§ Send Monthly Payslips via EmailJS</div>
        <div class="pb">
          <div id="pay-prog" class="prog-wrap">
            <div class="prog-top"><span class="prog-lbl" id="pay-pl">Sendingâ€¦</span><span class="prog-cnt" id="pay-pc">0/0</span></div>
            <div class="prog-bar-bg"><div class="prog-bar" id="pay-pb" style="width:0%"></div></div>
          </div>
          <div class="alert ai">â„¹ï¸ <div><strong>Real emails require EmailJS configured in âš™ï¸ Settings.</strong> Each employee receives a personalised payslip notification email. Payslip documents must be uploaded per employee first.</div></div>
          <div class="fg">
            <div class="fgrp"><label>Month & Year *</label><input type="month" id="ps-month"></div>
            <div class="fgrp"><label>Email Subject *</label><input type="text" id="ps-sub" value="Your Monthly Payslip"></div>
            <div class="fgrp full"><label>Email Body â€” use {name} and {month} as placeholders</label>
              <textarea id="ps-msg" rows="6">Dear {name},

Please find your payslip notification for {month}.

Your salary for this month has been processed. Please contact HR if you have any questions regarding your pay details.

Best regards,
HR Department</textarea></div>
          </div>
          <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap">
            <button class="btn bp" onclick="sendPayslips()" id="pay-btn">ğŸ“§ Send to All Employees</button>
            <span style="font-size:.82em;color:var(--t3)">Will send to: <strong id="pay-count">0</strong> employees</span>
          </div>
        </div>
      </div>

      <div class="panel"><div class="ph">Uploaded Payslip Documents</div>
        <div class="tw"><table><thead><tr><th>Title</th><th>Employee</th><th>Description</th><th>Uploaded</th><th>File</th><th>Actions</th></tr></thead>
        <tbody id="pay-tb"><tr><td colspan="6" class="nd">No payslips uploaded</td></tr></tbody></table></div></div>
    </section>

    <!-- â•â•â• PAY HISTORY â•â•â• -->
    <section id="sec-payhistory" class="page-sec">
      <div class="sh"><div class="sh-l"><h2>ğŸ“œ Payslip Send History</h2><p>Full log of every monthly payslip email batch</p></div></div>
      <div class="panel"><div class="ph">Send History</div>
        <div class="tw"><table><thead><tr><th>Month</th><th>Subject</th><th>Recipients</th><th>Email Status</th><th>Sent On</th><th>Actions</th></tr></thead>
        <tbody id="payh-tb"><tr><td colspan="6" class="nd">No payslips sent yet</td></tr></tbody></table></div></div>
    </section>

    <!-- â•â•â• BROADCAST â•â•â• -->
    <section id="sec-broadcast" class="page-sec">
      <div class="sh"><div class="sh-l"><h2>ğŸ“¢ Broadcast Messages</h2><p>Send announcements with text and file attachments to all staff or specific individuals</p></div></div>

      <div class="panel">
        <div class="ph">âœï¸ Compose New Broadcast</div>
        <div class="pb">
          <div id="bc-prog" class="prog-wrap">
            <div class="prog-top"><span class="prog-lbl" id="bc-pl">Sendingâ€¦</span><span class="prog-cnt" id="bc-pc">0/0</span></div>
            <div class="prog-bar-bg"><div class="prog-bar" id="bc-pb" style="width:0%"></div></div>
          </div>

          <div class="fg">
            <div class="fgrp"><label>Subject *</label><input type="text" id="bc-sub" placeholder="e.g. Q3 Company Update"></div>
            <div class="fgrp"><label>Priority / Type</label>
              <select id="bc-pri">
                <option value="normal">ğŸ“˜ Normal Announcement</option>
                <option value="urgent">ğŸ”´ URGENT â€” Immediate Attention</option>
                <option value="info">âœ… General Information</option>
              </select>
            </div>
            <div class="fgrp full"><label>Message Body * â€” use {name} to personalise per employee</label>
              <textarea id="bc-body" rows="7" oninput="document.getElementById('bc-cc').textContent=this.value.length+' characters'" placeholder="Type your message hereâ€¦"></textarea>
              <div class="cc" id="bc-cc">0 characters</div>
            </div>
          </div>

          <!-- FILE ATTACHMENTS -->
          <div class="fgrp">
            <label>ğŸ“ Attach Files <span style="font-weight:400;text-transform:none;font-size:1.1em">(PDF, DOC, DOCX, JPG, PNG, XLSX â€” max 5 MB each, up to 5 files)</span></label>
            <div class="fdz" id="bc-fdz" onclick="document.getElementById('bc-files').click()">
              <div class="fi">ğŸ“</div>
              <p>Click to browse or drag & drop files here</p>
              <p class="fh">Files will be listed in the email as attachment details. EmailJS embeds up to 5 files.</p>
            </div>
            <input type="file" id="bc-files" class="hidden" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xlsx" onchange="addAttachments(event)">
            <div class="att-list" id="att-list"></div>
          </div>

          <!-- RECIPIENTS -->
          <div class="fgrp">
            <label>Send To</label>
            <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
              <button type="button" class="btn bs bsm" onclick="selAll(true)">â˜‘ Select All</button>
              <button type="button" class="btn bs bsm" onclick="selAll(false)">â˜ Deselect All</button>
              <button type="button" class="btn bs bsm" onclick="openModal('m-dept')">ğŸ¢ By Department</button>
            </div>
            <div class="rsel">
              <div class="rsel-hd">
                <span>Choose recipients</span>
                <span id="sel-cnt" style="color:var(--ac);font-weight:700;font-size:.84em">0 selected</span>
              </div>
              <div class="rlist" id="r-list"><div style="padding:13px;color:var(--t3);font-size:.85em">Add employees first</div></div>
            </div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
            <button class="btn bp" onclick="sendBroadcast()" id="bc-btn">ğŸ“¢ Send Broadcast</button>
            <button class="btn bs" onclick="clearBCForm()">ğŸ—‘ Clear</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="ph">ğŸ“¬ Recent Broadcasts</div>
        <div class="pb" id="recent-bc"><div class="nd">No broadcasts sent yet</div></div>
      </div>
    </section>

    <!-- â•â•â• MESSAGE HISTORY â•â•â• -->
    <section id="sec-msghistory" class="page-sec">
      <div class="sh"><div class="sh-l"><h2>ğŸ’¬ Message History</h2><p>Full log of all broadcast messages sent to staff</p></div></div>
      <div class="panel"><div class="ph">Broadcast History</div>
        <div class="tw"><table><thead><tr><th>Subject</th><th>Priority</th><th>Attachments</th><th>Recipients</th><th>Email Status</th><th>Sent On</th><th>Actions</th></tr></thead>
        <tbody id="msg-tb"><tr><td colspan="7" class="nd">No messages sent yet</td></tr></tbody></table></div></div>
    </section>

    <!-- â•â•â• SETTINGS â•â•â• -->
    <section id="sec-settings" class="page-sec">
      <div class="sh"><div class="sh-l"><h2>âš™ï¸ Email Settings</h2><p>Configure EmailJS to send real emails directly from this app â€” no server needed</p></div></div>

      <div class="panel">
        <div class="ph">ğŸ“§ EmailJS Setup</div>
        <div class="pb">
          <div class="alert ai">â„¹ï¸ <div><strong>EmailJS is FREE (200 emails/month) and works directly in-browser.</strong> Sign up at <a href="https://www.emailjs.com" target="_blank" style="color:var(--ac)">emailjs.com â†’</a> then follow the steps below.</div></div>

          <div style="background:#f7fafc;border:1px solid var(--br);border-radius:8px;padding:18px;margin-bottom:18px">
            <div style="font-family:'Rajdhani',sans-serif;color:var(--th);font-size:1.05em;font-weight:700;letter-spacing:1px;margin-bottom:13px">SETUP STEPS (5 minutes)</div>
            <ol style="padding-left:18px;font-size:.87em;color:var(--t2);line-height:2.1">
              <li>Sign up free at <strong style="color:var(--ac)">emailjs.com</strong></li>
              <li><strong>Email Services</strong> â†’ Add Service â†’ connect Gmail or Outlook â†’ copy <strong>Service ID</strong></li>
              <li><strong>Email Templates</strong> â†’ Create Template using the variables below â†’ copy <strong>Template ID</strong></li>
              <li><strong>Account â†’ API Keys</strong> â†’ copy your <strong>Public Key</strong></li>
              <li>Paste all three below â†’ click <strong>Save & Connect</strong></li>
              <li>Hit <strong>Send Test Email</strong> to verify it works âœ…</li>
            </ol>
          </div>

          <div class="code-block">
            <div style="font-size:.75em;font-weight:700;color:#8ab0c8;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Required EmailJS Template Variables</div>
            <code>To Email: <span class="v">{{to_email}}</span></code>
            <code>To Name: <span class="v">{{to_name}}</span></code>
            <code>Subject: <span class="v">{{subject}}</span></code>
            <code>Message: <span class="v">{{message}}</span></code>
            <code>From Name: <span class="v">{{from_name}}</span></code>
            <code style="margin-top:8px;color:#7fa5c0">For attachments â€” add in template: <span class="v">{{attachment_info}}</span> (lists file names in email body)</code>
          </div>

          <div class="fg3" style="margin-top:16px">
            <div class="fgrp"><label>Public Key *</label><input type="text" id="cfg-pk" placeholder="e.g. AbCdEf_xxxxxxxxxxx"></div>
            <div class="fgrp"><label>Service ID *</label><input type="text" id="cfg-svc" placeholder="e.g. service_xxxxxxx"></div>
            <div class="fgrp"><label>Template ID *</label><input type="text" id="cfg-tpl" placeholder="e.g. template_xxxxxxx"></div>
          </div>
          <div class="fgrp"><label>Sender Name (shown in emails)</label><input type="text" id="cfg-name" placeholder="e.g. HR Department â€” Acme Ltd"></div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
            <button class="btn bp" onclick="saveEmailCfg()">ğŸ’¾ Save & Connect</button>
            <button class="btn bo" onclick="testEmail()">ğŸ“¤ Send Test Email</button>
            <button class="btn bs" onclick="disconnectEmail()">âœ– Disconnect</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="ph">ğŸ¢ Company Settings</div>
        <div class="pb">
          <div class="fg">
            <div class="fgrp"><label>Company Name</label><input type="text" id="cfg-co" placeholder="Your Company Name"></div>
            <div class="fgrp"><label>HR Contact Email</label><input type="email" id="cfg-hr" placeholder="hr@company.com"></div>
          </div>
          <button class="btn bp" onclick="saveCo()">ğŸ’¾ Save Company Settings</button>
        </div>
      </div>
    </section>

  </div><!-- /page -->
</div><!-- /main -->

<div id="tw"></div>

<!-- â•â•â• MODAL: ADD EMPLOYEE â•â•â• -->
<div class="mo" id="m-emp">
  <div class="mb">
    <div class="mh"><span>â• Add New Employee</span><button class="cx" onclick="closeModal('m-emp')">Ã—</button></div>
    <div class="mbody">
      <div class="fg">
        <div class="fgrp"><label>First Name *</label><input type="text" id="f-fn"></div>
        <div class="fgrp"><label>Last Name *</label><input type="text" id="f-ln"></div>
        <div class="fgrp"><label>Email Address *</label><input type="email" id="f-em"></div>
        <div class="fgrp"><label>Employee ID *</label><input type="text" id="f-eid"></div>
        <div class="fgrp"><label>Department</label>
          <select id="f-dept"><option value="">â€” Select â€”</option><option>Human Resources</option><option>Finance</option><option>Information Technology</option><option>Operations</option><option>Sales</option><option>Marketing</option><option>Legal</option><option>Administration</option></select></div>
        <div class="fgrp"><label>Position / Title</label><input type="text" id="f-pos"></div>
        <div class="fgrp"><label>Start Date</label><input type="date" id="f-sd"></div>
        <div class="fgrp"><label>Status</label><select id="f-st"><option value="Active">Active</option><option value="Inactive">Inactive</option></select></div>
      </div>
      <div style="display:flex;gap:9px;justify-content:flex-end;margin-top:8px">
        <button class="btn bs" onclick="closeModal('m-emp')">Cancel</button>
        <button class="btn bp" onclick="addEmployee()">Add Employee</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• MODAL: UPLOAD DOCUMENT â•â•â• -->
<div class="mo" id="m-upload">
  <div class="mb">
    <div class="mh"><span id="up-title">ğŸ“¤ Upload Document</span><button class="cx" onclick="closeModal('m-upload')">Ã—</button></div>
    <div class="mbody">
      <div class="fg">
        <div class="fgrp"><label>Employee *</label><select id="u-emp"></select></div>
        <div class="fgrp"><label>Document Type *</label>
          <select id="u-type"><option value="health">Health Tests & Records</option><option value="education">Education & Training Certification</option><option value="payslip">Payslip</option><option value="other">Other Document</option></select></div>
        <div class="fgrp full"><label>Document Title *</label><input type="text" id="u-title" placeholder="e.g. Annual Medical Check 2025"></div>
        <div class="fgrp full"><label>Description / Notes</label><textarea id="u-desc" rows="3" placeholder="Optional notesâ€¦"></textarea></div>
        <div class="fgrp full">
          <label>Select File *</label>
          <div class="fdz" id="u-fdz" onclick="document.getElementById('u-file').click()">
            <div class="fi">ğŸ“</div><p>Click to browse or drag & drop</p>
            <p class="fh">PDF, DOC, DOCX, JPG, PNG â€” Max 10 MB</p>
          </div>
          <input type="file" id="u-file" class="hidden" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" onchange="docFileChosen(event)">
          <div id="u-fc" class="fc"></div>
        </div>
      </div>
      <div style="display:flex;gap:9px;justify-content:flex-end;margin-top:8px">
        <button class="btn bs" onclick="closeModal('m-upload')">Cancel</button>
        <button class="btn bp" onclick="uploadDoc()">Upload</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• MODAL: VIEW SEND RECORD â•â•â• -->
<div class="mo" id="m-pay-view">
  <div class="mb">
    <div class="mh"><span>ğŸ“§ Payslip Send Record</span><button class="cx" onclick="closeModal('m-pay-view')">Ã—</button></div>
    <div class="mbody" id="pay-view-body"></div>
  </div>
</div>

<!-- â•â•â• MODAL: VIEW BROADCAST â•â•â• -->
<div class="mo" id="m-bc-view">
  <div class="mb">
    <div class="mh"><span>ğŸ“¢ Broadcast Details</span><button class="cx" onclick="closeModal('m-bc-view')">Ã—</button></div>
    <div class="mbody" id="bc-view-body"></div>
  </div>
</div>

<!-- â•â•â• MODAL: VIEW EMPLOYEE â•â•â• -->
<div class="mo" id="m-emp-view">
  <div class="mb">
    <div class="mh"><span>ğŸ‘¤ Employee Profile</span><button class="cx" onclick="closeModal('m-emp-view')">Ã—</button></div>
    <div class="mbody" id="emp-view-body"></div>
  </div>
</div>

<!-- â•â•â• MODAL: DEPARTMENT FILTER â•â•â• -->
<div class="mo" id="m-dept">
  <div class="mb" style="max-width:400px">
    <div class="mh"><span>ğŸ¢ Select by Department</span><button class="cx" onclick="closeModal('m-dept')">Ã—</button></div>
    <div class="mbody">
      <div id="dept-list" style="display:flex;flex-direction:column;gap:9px"></div>
      <div style="display:flex;gap:9px;justify-content:flex-end;margin-top:16px">
        <button class="btn bs" onclick="closeModal('m-dept')">Cancel</button>
        <button class="btn bp" onclick="applyDept()">Apply</button>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let emps   = JSON.parse(localStorage.getItem('h4_emp')  || '[]');
let docs   = JSON.parse(localStorage.getItem('h4_doc')  || '[]');
let payH   = JSON.parse(localStorage.getItem('h4_payh') || '[]');
let bcs    = JSON.parse(localStorage.getItem('h4_bcs')  || '[]');
let acts   = JSON.parse(localStorage.getItem('h4_act')  || '[]');
let eCfg   = JSON.parse(localStorage.getItem('h4_ecfg') || '{}');
let coCfg  = JSON.parse(localStorage.getItem('h4_co')   || '{}');

function save(){
  localStorage.setItem('h4_emp',  JSON.stringify(emps));
  localStorage.setItem('h4_doc',  JSON.stringify(docs));
  localStorage.setItem('h4_payh', JSON.stringify(payH));
  localStorage.setItem('h4_bcs',  JSON.stringify(bcs));
  localStorage.setItem('h4_act',  JSON.stringify(acts));
  localStorage.setItem('h4_ecfg', JSON.stringify(eCfg));
  localStorage.setItem('h4_co',   JSON.stringify(coCfg));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMAILJS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ejsOk = false;

function initEJS(){
  if(eCfg.pk){
    try{ emailjs.init(eCfg.pk); ejsOk=true; setES(true); }
    catch(e){ ejsOk=false; setES(false); }
  }
}

function setES(ok){
  const el=document.getElementById('es');
  el.textContent = ok ? 'â— Email Connected' : 'â— Email Offline';
  el.className   = ok ? 'es-on' : 'es-off';
}

// Core send â€” attachmentInfo is a plain-text list of file names (browsers can't send binary via EmailJS easily,
// so we embed the attachment names + instructions clearly in the email body)
async function ejsSend(toEmail, toName, subject, message, attachmentInfo){
  if(!ejsOk || !eCfg.svc || !eCfg.tpl) return false;
  const fullMsg = attachmentInfo
    ? message + '\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nğŸ“ ATTACHMENTS:\n' + attachmentInfo + '\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n(Files are stored in the HR system. Contact HR to receive copies.)'
    : message;
  try{
    await emailjs.send(eCfg.svc, eCfg.tpl, {
      to_email:        toEmail,
      to_name:         toName,
      subject:         subject,
      message:         fullMsg,
      from_name:       eCfg.senderName || coCfg.name || 'HR Department',
      attachment_info: attachmentInfo || 'No attachments',
    });
    return true;
  }catch(e){ console.error('EJS err:',e); return false; }
}

function saveEmailCfg(){
  const pk=V('cfg-pk'), svc=V('cfg-svc'), tpl=V('cfg-tpl');
  if(!pk||!svc||!tpl){ toast('Fill all three EmailJS fields','err'); return; }
  eCfg={pk, svc, tpl, senderName:V('cfg-name')};
  save(); initEJS();
  toast(ejsOk ? 'âœ… EmailJS connected â€” real emails will now be sent!' : 'Saved â€” check keys if emails fail','ok');
}

function disconnectEmail(){
  eCfg={}; ejsOk=false; save(); setES(false);
  ['cfg-pk','cfg-svc','cfg-tpl','cfg-name'].forEach(id=>{ const e=document.getElementById(id); if(e) e.value=''; });
  toast('Email disconnected');
}

async function testEmail(){
  if(!emps.length){ toast('Add an employee first','err'); return; }
  if(!ejsOk){ toast('Configure EmailJS in Settings first','err'); return; }
  const e=emps[0];
  const ok=await ejsSend(e.email,`${e.firstName} ${e.lastName}`,'âœ… HRIS Test Email',`Hi ${e.firstName},\n\nThis is a test from your HR Information System.\n\nIf you received this, email sending is working correctly!\n\nBest regards,\nHR Admin`,'');
  toast(ok ? `Test email sent to ${e.email} âœ…` : 'Send failed â€” check EmailJS credentials','err');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PM={
  dashboard: {s:'sec-dashboard',  t:'Dashboard',            m:'Human Resources Overview'},
  employees: {s:'sec-employees',  t:'Employees',            m:'Manage your staff directory'},
  health:    {s:'sec-health',     t:'Health Records',       m:'Medical tests & documentation'},
  education: {s:'sec-education',  t:'Education & Training', m:'Certifications and qualifications'},
  documents: {s:'sec-documents',  t:'All Documents',        m:'Complete document archive'},
  payslips:  {s:'sec-payslips',   t:'Payslips',             m:'Monthly payslip management'},
  payhistory:{s:'sec-payhistory', t:'Payslip Send History', m:'Full email send log'},
  broadcast: {s:'sec-broadcast',  t:'Broadcast Messages',   m:'CEO & Admin communications'},
  msghistory:{s:'sec-msghistory', t:'Message History',      m:'All broadcast messages sent'},
  settings:  {s:'sec-settings',   t:'Email Settings',       m:'EmailJS configuration'},
};

function pg(key, el){
  const c=PM[key]; if(!c) return;
  document.querySelectorAll('.page-sec').forEach(s=>s.classList.remove('active'));
  document.getElementById(c.s).classList.add('active');
  document.getElementById('tt').textContent=c.t;
  document.getElementById('tm').textContent=c.m;
  document.querySelectorAll('nav ul li a').forEach(a=>a.classList.remove('active'));
  if(el) el.classList.add('active');
  else document.querySelectorAll('nav ul li a').forEach(a=>{ if(a.getAttribute('onclick')?.includes(`'${key}'`)) a.classList.add('active'); });
  if(key==='settings') loadSettingsForm();
  if(key==='payslips') document.getElementById('pay-count').textContent=emps.length;
  if(key==='broadcast'){ renderRList(); }
  refreshAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.mo').forEach(m=>m.addEventListener('click',e=>{ if(e.target===m) m.classList.remove('open'); }));

function openUpload(type){
  const titles={health:'ğŸ¥ Upload Health Record',education:'ğŸ“ Upload Certification',payslip:'ğŸ’° Upload Payslip',other:'ğŸ“„ Upload Document'};
  document.getElementById('up-title').textContent = titles[type]||'ğŸ“¤ Upload Document';
  document.getElementById('u-type').value = type;
  refreshEmpSel();
  openModal('m-upload');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE HANDLING â€” DOCUMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let docFile = null;
function docFileChosen(e){
  const f=e.target.files[0]; if(!f) return;
  if(f.size>10*1024*1024){ toast('File must be < 10 MB','err'); return; }
  docFile=f;
  document.getElementById('u-fc').textContent='âœ… '+f.name+' ('+fmtSz(f.size)+')';
}
const uFDZ=document.getElementById('u-fdz');
uFDZ.addEventListener('dragover',e=>{e.preventDefault();uFDZ.classList.add('over');});
uFDZ.addEventListener('dragleave',()=>uFDZ.classList.remove('over'));
uFDZ.addEventListener('drop',e=>{e.preventDefault();uFDZ.classList.remove('over');const f=e.dataTransfer.files[0];if(f) docFileChosen({target:{files:[f]}});});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE HANDLING â€” BROADCAST ATTACHMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let bcAttachments = []; // [{name, size, type, base64}]

function addAttachments(e){
  const files=[...e.target.files];
  files.forEach(f=>{
    if(f.size>5*1024*1024){ toast(`${f.name} exceeds 5 MB limit â€” skipped`,'err'); return; }
    if(bcAttachments.length>=5){ toast('Maximum 5 attachments per broadcast','err'); return; }
    if(bcAttachments.find(a=>a.name===f.name)) return; // no duplicates
    const reader=new FileReader();
    reader.onload=()=>{
      bcAttachments.push({name:f.name, size:f.size, type:f.type, base64:reader.result.split(',')[1]});
      renderAttList();
    };
    reader.readAsDataURL(f);
  });
  e.target.value=''; // reset so same file can be re-added if removed
}

function removeAtt(name){
  bcAttachments=bcAttachments.filter(a=>a.name!==name);
  renderAttList();
}

function renderAttList(){
  const c=document.getElementById('att-list');
  if(!bcAttachments.length){ c.innerHTML=''; return; }
  c.innerHTML=bcAttachments.map(a=>`
    <div class="att-chip">
      <span class="att-icon">${attIcon(a.type)}</span>
      <span class="att-name" title="${a.name}">${a.name}</span>
      <span style="color:var(--t3);font-size:.75em">${fmtSz(a.size)}</span>
      <button class="att-rm" onclick="removeAtt('${a.name.replace(/'/g,"\\'")}')">âœ•</button>
    </div>`).join('');
}

function attIcon(mime){
  if(mime.includes('pdf')) return 'ğŸ“•';
  if(mime.includes('word')||mime.includes('doc')) return 'ğŸ“˜';
  if(mime.includes('sheet')||mime.includes('excel')) return 'ğŸ“—';
  if(mime.includes('image')) return 'ğŸ–¼ï¸';
  return 'ğŸ“„';
}

const bcFDZ=document.getElementById('bc-fdz');
bcFDZ.addEventListener('dragover',e=>{e.preventDefault();bcFDZ.classList.add('over');});
bcFDZ.addEventListener('dragleave',()=>bcFDZ.classList.remove('over'));
bcFDZ.addEventListener('drop',e=>{e.preventDefault();bcFDZ.classList.remove('over');addAttachments({target:{files:e.dataTransfer.files}});});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMPLOYEES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addEmployee(){
  const fn=V('f-fn'),ln=V('f-ln'),em=V('f-em'),eid=V('f-eid');
  if(!fn||!ln||!em||!eid){ toast('Fill all required fields','err'); return; }
  emps.push({id:Date.now(),firstName:fn,lastName:ln,email:em,employeeId:eid,department:V('f-dept'),position:V('f-pos'),startDate:V('f-sd'),status:V('f-st')||'Active',addedAt:new Date().toISOString()});
  save(); log(`Added employee: ${fn} ${ln}`);
  ['f-fn','f-ln','f-em','f-eid','f-dept','f-pos','f-sd'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  document.getElementById('f-st').value='Active';
  closeModal('m-emp'); refreshAll(); toast(`${fn} ${ln} added`,'ok');
}

function delEmp(id){
  if(!confirm('Delete this employee and all their documents?')) return;
  const e=emps.find(x=>x.id===id);
  emps=emps.filter(x=>x.id!==id);
  docs=docs.filter(x=>x.empId!==id);
  save(); log(`Deleted employee: ${e?.firstName} ${e?.lastName}`);
  refreshAll(); toast('Employee deleted');
}

function viewEmp(id){
  const e=emps.find(x=>x.id===id); if(!e) return;
  const d=docs.filter(x=>x.empId===id);
  document.getElementById('emp-view-body').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px">
      <div><div style="font-size:.72em;color:var(--t3);text-transform:uppercase;letter-spacing:1px">Full Name</div><strong style="font-size:1.1em">${e.firstName} ${e.lastName}</strong></div>
      <div><div style="font-size:.72em;color:var(--t3);text-transform:uppercase;letter-spacing:1px">Employee ID</div><strong>${e.employeeId}</strong></div>
      <div><div style="font-size:.72em;color:var(--t3);text-transform:uppercase;letter-spacing:1px">Email</div><div>${e.email}</div></div>
      <div><div style="font-size:.72em;color:var(--t3);text-transform:uppercase;letter-spacing:1px">Department</div><div>${e.department||'â€”'}</div></div>
      <div><div style="font-size:.72em;color:var(--t3);text-transform:uppercase;letter-spacing:1px">Position</div><div>${e.position||'â€”'}</div></div>
      <div><div style="font-size:.72em;color:var(--t3);text-transform:uppercase;letter-spacing:1px">Status</div><span class="badge ${e.status==='Active'?'bon':'boff'}">${e.status}</span></div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:18px">
      <div class="sc"><div class="sn" style="font-size:1.7em">${d.filter(x=>x.type==='health').length}</div><div class="sl">Health</div></div>
      <div class="sc"><div class="sn" style="font-size:1.7em">${d.filter(x=>x.type==='education').length}</div><div class="sl">Certifications</div></div>
      <div class="sc"><div class="sn" style="font-size:1.7em">${d.filter(x=>x.type==='payslip').length}</div><div class="sl">Payslips</div></div>
    </div>
    ${d.length?`<div class="panel"><div class="ph">Documents</div><div class="tw"><table><thead><tr><th>Title</th><th>Type</th><th>Uploaded</th><th>File</th></tr></thead><tbody>${d.map(x=>`<tr><td><strong>${x.title}</strong></td><td><span class="badge ${bdg(x.type)}">${tName(x.type)}</span></td><td class="m">${fmtDt(x.uploadedAt)}</td><td class="m">${x.fileName}</td></tr>`).join('')}</tbody></table></div></div>`:''}`;
  openModal('m-emp-view');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOCUMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function uploadDoc(){
  const empId=document.getElementById('u-emp').value, type=V('u-type'), title=V('u-title');
  if(!empId||!type||!title||!docFile){ toast('Fill all required fields and select a file','err'); return; }
  const emp=emps.find(e=>e.id==empId);
  docs.push({id:Date.now(),empId:parseInt(empId),empName:`${emp.firstName} ${emp.lastName}`,type,title,description:V('u-desc'),fileName:docFile.name,fileSize:docFile.size,uploadedAt:new Date().toISOString()});
  save(); log(`Uploaded ${type} doc for ${emp.firstName} ${emp.lastName}: ${title}`);
  docFile=null;
  ['u-file','u-title','u-desc'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  document.getElementById('u-fc').textContent='';
  closeModal('m-upload'); refreshAll(); toast(`"${title}" uploaded`,'ok');
}

function delDoc(id){
  if(!confirm('Delete this document?')) return;
  const d=docs.find(x=>x.id===id);
  docs=docs.filter(x=>x.id!==id);
  save(); log(`Deleted document: ${d?.title}`); refreshAll(); toast('Document deleted');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAYSLIPS â€” SEND VIA EMAILJS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendPayslips(){
  const month=V('ps-month'), subj=V('ps-sub'), msgT=V('ps-msg');
  if(!month){ toast('Select a month','err'); return; }
  if(!emps.length){ toast('No employees found','err'); return; }

  setBusy('pay-btn',true); showProg('pay-prog',true);
  let sent=0,fail=0; const total=emps.length; const results=[];

  for(let i=0;i<emps.length;i++){
    const e=emps[i];
    const msg=msgT.replace(/{name}/g,`${e.firstName} ${e.lastName}`).replace(/{month}/g,fmtMo(month));
    updProg('pay-prog',`Sending to ${e.firstName} ${e.lastName}â€¦`,i,total);
    const ok=ejsOk ? await ejsSend(e.email,`${e.firstName} ${e.lastName}`,`${subj} â€” ${fmtMo(month)}`,msg,'') : false;
    if(ok) sent++; else fail++;
    results.push({empId:e.id,name:`${e.firstName} ${e.lastName}`,email:e.email,sent:ok});
    await wait(350);
  }

  updProg('pay-prog','Done!',total,total);
  setTimeout(()=>showProg('pay-prog',false),2200);
  setBusy('pay-btn',false);

  payH.unshift({id:Date.now(),month,subject:subj,message:msgT,sentAt:new Date().toISOString(),recipients:results,sent,fail,ejsUsed:ejsOk});
  save(); log(`Payslips for ${fmtMo(month)}: ${ejsOk?`${sent} sent, ${fail} failed`:'logged (no email config)'}`);
  refreshAll();
  toast(ejsOk ? `âœ… Payslips: ${sent} delivered, ${fail} failed` : `ğŸ“‹ Logged for ${emps.length} employees â€” configure EmailJS to send real emails`,'ok');
}

function viewPayRecord(id){
  const r=payH.find(x=>x.id===id); if(!r) return;
  document.getElementById('pay-view-body').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:13px;margin-bottom:16px">
      <div><div style="font-size:.72em;color:var(--t3);text-transform:uppercase;letter-spacing:1px">Month</div><strong>${fmtMo(r.month)}</strong></div>
      <div><div style="font-size:.72em;color:var(--t3);text-transform:uppercase;letter-spacing:1px">Sent On</div><strong>${fmtDt(r.sentAt)}</strong></div>
      <div><div style="font-size:.72em;color:var(--t3);text-transform:uppercase;letter-spacing:1px">Total Recipients</div><strong>${r.recipients.length}</strong></div>
      <div><div style="font-size:.72em;color:var(--t3);text-transform:uppercase;letter-spacing:1px">Email Status</div><strong>${r.ejsUsed?`${r.sent} delivered Â· ${r.fail} failed`:'Logged only (no email config)'}</strong></div>
    </div>
    <div class="ep"><div class="ep-from">From: ${eCfg.senderName||coCfg.name||'HR Department'} â†’ All Employees</div>
      <div class="ep-sub">Subject: ${r.subject} â€” ${fmtMo(r.month)}</div>
      <div class="ep-body">${r.message}</div></div>
    <div style="margin-top:16px"><div style="font-size:.76em;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--t3);margin-bottom:9px">Recipients</div>
      <div style="display:flex;flex-wrap:wrap;gap:7px">${r.recipients.map(rc=>`<span style="background:${rc.sent?'#c6f6d5':'#fed7d7'};border:1px solid ${rc.sent?'#9ae6b4':'#feb2b2'};color:${rc.sent?'#1a4731':'#742a2a'};padding:3px 11px;border-radius:20px;font-size:.77em;font-weight:600">${rc.sent?'âœ…':'âš ï¸'} ${rc.name}</span>`).join('')}</div>
    </div>`;
  openModal('m-pay-view');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BROADCAST â€” SEND WITH ATTACHMENTS VIA EMAILJS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRList(){
  const c=document.getElementById('r-list');
  if(!emps.length){ c.innerHTML='<div style="padding:12px;color:var(--t3);font-size:.85em">Add employees first</div>'; return; }
  c.innerHTML=emps.map(e=>`
    <label>
      <input type="checkbox" class="rc" value="${e.id}" onchange="updSelCnt()">
      <span><strong>${e.firstName} ${e.lastName}</strong> â€” ${e.email}</span>
      <span class="dept-tag">${e.department||''}</span>
    </label>`).join('');
  updSelCnt();
}

function updSelCnt(){
  document.getElementById('sel-cnt').textContent=document.querySelectorAll('.rc:checked').length+' selected';
}

function selAll(v){ document.querySelectorAll('.rc').forEach(cb=>cb.checked=v); updSelCnt(); }

function openDeptModal(){
  const depts=[...new Set(emps.map(e=>e.department).filter(Boolean))];
  if(!depts.length){ toast('Assign departments to employees first','err'); return; }
  document.getElementById('dept-list').innerHTML=depts.map(d=>`
    <label style="display:flex;align-items:center;gap:10px;padding:9px;background:#f7fafc;border-radius:6px;cursor:pointer;font-size:.88em;font-weight:600;color:var(--t1)">
      <input type="checkbox" class="dc" value="${d}" style="width:15px;height:15px;accent-color:var(--ac)">
      ğŸ¢ ${d}<span style="margin-left:auto;color:var(--t3);font-weight:400;font-size:.82em">${emps.filter(e=>e.department===d).length} staff</span>
    </label>`).join('');
  openModal('m-dept');
}

function applyDept(){
  const sel=[...document.querySelectorAll('.dc:checked')].map(x=>x.value);
  document.querySelectorAll('.rc').forEach(cb=>{
    const e=emps.find(x=>x.id==cb.value);
    if(e) cb.checked=sel.includes(e.department);
  });
  updSelCnt(); closeModal('m-dept');
}

async function sendBroadcast(){
  const subj=V('bc-sub'), pri=V('bc-pri'), body=V('bc-body');
  const selIds=[...document.querySelectorAll('.rc:checked')].map(cb=>parseInt(cb.value));

  if(!subj){ toast('Enter a subject','err'); return; }
  if(!body){ toast('Enter a message body','err'); return; }
  if(!selIds.length){ toast('Select at least one recipient','err'); return; }

  const attInfo = bcAttachments.length
    ? bcAttachments.map((a,i)=>`${i+1}. ${a.name} (${fmtSz(a.size)})`).join('\n')
    : '';

  setBusy('bc-btn',true); showProg('bc-prog',true);
  let sent=0, fail=0; const total=selIds.length; const results=[];

  for(let i=0;i<selIds.length;i++){
    const e=emps.find(x=>x.id===selIds[i]); if(!e) continue;
    const personalMsg=body.replace(/{name}/g,`${e.firstName} ${e.lastName}`);
    const fullSubj=pri==='urgent'?`ğŸ”´ URGENT: ${subj}`:subj;
    updProg('bc-prog',`Sending to ${e.firstName} ${e.lastName}â€¦`,i,total);
    const ok=ejsOk ? await ejsSend(e.email,`${e.firstName} ${e.lastName}`,fullSubj,personalMsg,attInfo) : false;
    if(ok) sent++; else fail++;
    results.push({empId:e.id,name:`${e.firstName} ${e.lastName}`,email:e.email,sent:ok});
    await wait(380);
  }

  updProg('bc-prog','Done!',total,total);
  setTimeout(()=>showProg('bc-prog',false),2200);
  setBusy('bc-btn',false);

  bcs.unshift({id:Date.now(),subject:subj,priority:pri,body,sentAt:new Date().toISOString(),
    recipients:results,attachments:bcAttachments.map(a=>({name:a.name,size:a.size,type:a.type})),
    sent,fail,ejsUsed:ejsOk});
  save(); log(`Broadcast "${subj}" â†’ ${selIds.length} recipients (${pri})${bcAttachments.length?' + '+bcAttachments.length+' attachment(s)':''}`);
  clearBCForm(); refreshAll();
  toast(ejsOk ? `âœ… Broadcast: ${sent} delivered, ${fail} failed` : `ğŸ“‹ Broadcast logged for ${selIds.length} staff â€” configure EmailJS for real emails`,'ok');
}

function clearBCForm(){
  ['bc-sub','bc-body'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  document.getElementById('bc-pri').value='normal';
  document.getElementById('bc-cc').textContent='0 characters';
  bcAttachments=[]; renderAttList();
  selAll(false);
}

function viewBroadcast(id){
  const b=bcs.find(x=>x.id===id); if(!b) return;
  document.getElementById('bc-view-body').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:13px;margin-bottom:16px">
      <div><div style="font-size:.72em;color:var(--t3);text-transform:uppercase;letter-spacing:1px">Subject</div><strong>${b.subject}</strong></div>
      <div><div style="font-size:.72em;color:var(--t3);text-transform:uppercase;letter-spacing:1px">Priority</div><span class="badge ${b.priority==='urgent'?'burg':b.priority==='info'?'binf':'bnorm'}">${b.priority.toUpperCase()}</span></div>
      <div><div style="font-size:.72em;color:var(--t3);text-transform:uppercase;letter-spacing:1px">Sent On</div><strong>${fmtDt(b.sentAt)}</strong></div>
      <div><div style="font-size:.72em;color:var(--t3);text-transform:uppercase;letter-spacing:1px">Email Status</div><strong>${b.ejsUsed?`${b.sent} delivered Â· ${b.fail} failed`:'Logged only'}</strong></div>
    </div>
    ${b.attachments?.length ? `<div style="margin-bottom:14px"><div style="font-size:.76em;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--t3);margin-bottom:8px">ğŸ“ Attachments (${b.attachments.length})</div><div class="att-list">${b.attachments.map(a=>`<div class="att-chip"><span class="att-icon">${attIcon(a.type)}</span><span class="att-name">${a.name}</span><span style="color:var(--t3);font-size:.75em">${fmtSz(a.size)}</span></div>`).join('')}</div></div>` : ''}
    <div class="ep"><div class="ep-from">From: ${eCfg.senderName||coCfg.name||'HR Department'}</div>
      <div class="ep-sub">Subject: ${b.priority==='urgent'?'ğŸ”´ URGENT: ':''}${b.subject}</div>
      <div class="ep-body">${b.body}</div></div>
    <div style="margin-top:16px"><div style="font-size:.76em;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--t3);margin-bottom:9px">Recipients (${b.recipients.length})</div>
      <div style="display:flex;flex-wrap:wrap;gap:7px">${b.recipients.map(r=>`<span style="background:${r.sent?'#c6f6d5':'#fed7d7'};border:1px solid ${r.sent?'#9ae6b4':'#feb2b2'};color:${r.sent?'#1a4731':'#742a2a'};padding:3px 11px;border-radius:20px;font-size:.77em;font-weight:600">${r.sent?'âœ…':'âš ï¸'} ${r.name}</span>`).join('')}</div>
    </div>`;
  openModal('m-bc-view');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshAll(){
  renderDash(); renderEmps(); renderDocTbl('hlth-tb','health',6);
  renderDocTbl('edu-tb','education',6); renderAllDocs();
  renderDocTbl('pay-tb','payslip',6); renderPayH();
  renderMsgH(); renderBCCards(); refreshEmpSel();
  document.getElementById('pay-count').textContent=emps.length;
}

function renderDash(){
  S('s1',emps.length); S('s2',docs.length);
  S('s3',docs.filter(d=>d.type==='health').length);
  S('s4',docs.filter(d=>d.type==='education').length);
  S('s5',payH.reduce((s,r)=>s+r.recipients.length,0));
  S('s6',bcs.reduce((s,b)=>s+b.recipients.length,0));
  const el=document.getElementById('dash-act');
  el.innerHTML=acts.length ? acts.slice(0,8).map(a=>`<div class="act-item"><div class="act-dot"></div><div class="act-text">${a.msg}</div><div class="act-time">${relT(a.ts)}</div></div>`).join('') : '<div class="nd">No activity yet</div>';
}

function renderEmps(){
  const tb=document.getElementById('emp-tb');
  if(!emps.length){ tb.innerHTML='<tr><td colspan="9" class="nd">No employees added yet</td></tr>'; return; }
  tb.innerHTML=emps.map(e=>`<tr>
    <td><strong>${e.firstName} ${e.lastName}</strong></td>
    <td class="m">${e.employeeId}</td><td>${e.department||'â€”'}</td><td>${e.position||'â€”'}</td>
    <td class="m">${e.email}</td><td class="m">${e.startDate?fmtDt(e.startDate):'â€”'}</td>
    <td><strong>${docs.filter(d=>d.empId===e.id).length}</strong></td>
    <td><span class="badge ${e.status==='Active'?'bon':'boff'}">${e.status}</span></td>
    <td style="white-space:nowrap"><button class="btn bs bsm" onclick="viewEmp(${e.id})">ğŸ‘ View</button> <button class="btn bd bsm" onclick="delEmp(${e.id})">ğŸ—‘</button></td>
  </tr>`).join('');
}

function renderDocTbl(tbId, type, cols){
  const tb=document.getElementById(tbId);
  const d=docs.filter(x=>x.type===type);
  if(!d.length){ tb.innerHTML=`<tr><td colspan="${cols}" class="nd">No records found</td></tr>`; return; }
  tb.innerHTML=d.map(x=>`<tr>
    <td><strong>${x.title}</strong></td><td>${x.empName}</td>
    <td class="m">${x.description||'â€”'}</td><td class="m">${fmtDt(x.uploadedAt)}</td>
    <td class="m">${x.fileName} <span style="color:#9ab;font-size:.78em">(${fmtSz(x.fileSize)})</span></td>
    <td><button class="btn bd bsm" onclick="delDoc(${x.id})">ğŸ—‘</button></td>
  </tr>`).join('');
}

function renderAllDocs(){
  const tb=document.getElementById('doc-tb');
  if(!docs.length){ tb.innerHTML='<tr><td colspan="7" class="nd">No documents uploaded</td></tr>'; return; }
  tb.innerHTML=docs.map(d=>`<tr>
    <td><strong>${d.title}</strong></td><td>${d.empName}</td>
    <td><span class="badge ${bdg(d.type)}">${tName(d.type)}</span></td>
    <td class="m">${d.description||'â€”'}</td><td class="m">${fmtDt(d.uploadedAt)}</td>
    <td class="m">${fmtSz(d.fileSize)}</td>
    <td><button class="btn bd bsm" onclick="delDoc(${d.id})">ğŸ—‘</button></td>
  </tr>`).join('');
}

function renderPayH(){
  const tb=document.getElementById('payh-tb');
  if(!payH.length){ tb.innerHTML='<tr><td colspan="6" class="nd">No payslips sent yet</td></tr>'; return; }
  tb.innerHTML=payH.map(r=>`<tr>
    <td><strong>${fmtMo(r.month)}</strong></td><td>${r.subject}</td>
    <td><span class="badge bon">${r.recipients.length} Employees</span></td>
    <td>${r.ejsUsed?`<span class="badge bsent">${r.sent} sent</span>${r.fail?` <span class="badge burg">${r.fail} failed</span>`:''}`:'<span class="badge bdraft">Logged only</span>'}</td>
    <td class="m">${fmtDt(r.sentAt)}</td>
    <td><button class="btn bs bsm" onclick="viewPayRecord(${r.id})">ğŸ‘ View</button></td>
  </tr>`).join('');
}

function renderMsgH(){
  const tb=document.getElementById('msg-tb');
  if(!bcs.length){ tb.innerHTML='<tr><td colspan="7" class="nd">No messages sent yet</td></tr>'; return; }
  tb.innerHTML=bcs.map(b=>`<tr>
    <td><strong>${b.priority==='urgent'?'ğŸ”´ ':b.priority==='info'?'âœ… ':''}${b.subject}</strong></td>
    <td><span class="badge ${b.priority==='urgent'?'burg':b.priority==='info'?'binf':'bnorm'}">${b.priority.toUpperCase()}</span></td>
    <td>${b.attachments?.length ? `<span class="att-badge">ğŸ“ ${b.attachments.length} file${b.attachments.length>1?'s':''}</span>` : '<span class="m">â€”</span>'}</td>
    <td><span class="badge bon">${b.recipients.length} staff</span></td>
    <td>${b.ejsUsed?`<span class="badge bsent">${b.sent} sent</span>${b.fail?` <span class="badge burg">${b.fail} failed</span>`:''}`:'<span class="badge bdraft">Logged only</span>'}</td>
    <td class="m">${fmtDt(b.sentAt)}</td>
    <td><button class="btn bs bsm" onclick="viewBroadcast(${b.id})">ğŸ‘ View</button></td>
  </tr>`).join('');
}

function renderBCCards(){
  const el=document.getElementById('recent-bc');
  if(!bcs.length){ el.innerHTML='<div class="nd">No broadcasts sent yet</div>'; return; }
  el.innerHTML=bcs.slice(0,5).map(b=>`
    <div class="bc-card ${b.priority}">
      <div class="bc-hd">
        <div>
          <div class="bc-title">${b.priority==='urgent'?'ğŸ”´ URGENT: ':''}${b.subject}</div>
          <div class="bc-meta">Sent ${relT(new Date(b.sentAt).getTime())} Â· ${b.recipients.length} recipients Â· ${b.ejsUsed?`${b.sent} emails delivered`:'Logged only'}</div>
        </div>
        <div style="display:flex;gap:7px;flex-shrink:0">
          <span class="badge ${b.priority==='urgent'?'burg':b.priority==='info'?'binf':'bnorm'}">${b.priority.toUpperCase()}</span>
          <button class="btn bs bsm" onclick="viewBroadcast(${b.id})">ğŸ‘ View</button>
        </div>
      </div>
      <div class="bc-body">${b.body.length>180?b.body.slice(0,180)+'â€¦':b.body}</div>
      <div class="bc-foot">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <div class="rchips">${b.recipients.slice(0,5).map(r=>`<span class="rchip">${r.name.split(' ')[0]}</span>`).join('')}${b.recipients.length>5?`<span class="rchip">+${b.recipients.length-5}</span>`:''}</div>
          ${b.attachments?.length?`<span class="att-badge">ğŸ“ ${b.attachments.length} attachment${b.attachments.length>1?'s':''}</span>`:''}
        </div>
        <span style="font-size:.74em;color:var(--t3)">${fmtDt(b.sentAt)}</span>
      </div>
    </div>`).join('');
}

function refreshEmpSel(){
  const sel=document.getElementById('u-emp');
  sel.innerHTML=emps.length ? emps.map(e=>`<option value="${e.id}">${e.firstName} ${e.lastName} (${e.employeeId})</option>`).join('') : '<option value="">â€” No employees yet â€”</option>';
}

function loadSettingsForm(){
  if(eCfg.pk) document.getElementById('cfg-pk').value=eCfg.pk;
  if(eCfg.svc) document.getElementById('cfg-svc').value=eCfg.svc;
  if(eCfg.tpl) document.getElementById('cfg-tpl').value=eCfg.tpl;
  if(eCfg.senderName) document.getElementById('cfg-name').value=eCfg.senderName;
  if(coCfg.name) document.getElementById('cfg-co').value=coCfg.name;
  if(coCfg.hrEmail) document.getElementById('cfg-hr').value=coCfg.hrEmail;
}

function saveCo(){ coCfg={name:V('cfg-co'),hrEmail:V('cfg-hr')}; save(); toast('Company settings saved','ok'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function V(id){ return document.getElementById(id)?.value?.trim()||''; }
function S(id,v){ const e=document.getElementById(id); if(e) e.textContent=v; }
function fmtDt(s){ if(!s)return'â€”'; return new Date(s).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}); }
function fmtMo(s){ if(!s)return'â€”'; return new Date(s+'-01').toLocaleDateString('en-US',{month:'long',year:'numeric'}); }
function fmtSz(b){ if(!b)return'â€”'; if(b<1024)return b+' B'; if(b<1048576)return(b/1024).toFixed(1)+' KB'; return(b/1048576).toFixed(2)+' MB'; }
function tName(t){ return{health:'Health',education:'Education',payslip:'Payslip',other:'Other'}[t]||'Doc'; }
function bdg(t){ return{health:'bh',education:'be',payslip:'bpay',other:'bother'}[t]||'bother'; }
function log(msg){ acts.unshift({msg,ts:Date.now()}); if(acts.length>25) acts=acts.slice(0,25); save(); }
function relT(ts){ const s=Math.floor((Date.now()-ts)/1000); if(s<60)return'Just now'; if(s<3600)return Math.floor(s/60)+'m ago'; if(s<86400)return Math.floor(s/3600)+'h ago'; return Math.floor(s/86400)+'d ago'; }
function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }
function showProg(id,on){ document.getElementById(id).classList.toggle('on',on); }
function updProg(id,lbl,i,tot){
  document.getElementById(id.replace('-prog','-pl')||id+'_pl').textContent=lbl;
  document.getElementById(id.replace('-prog','-pc')||id+'_pc').textContent=`${i}/${tot}`;
  document.getElementById(id.replace('-prog','-pb')||id+'_pb').style.width=tot?Math.round(i/tot*100)+'%':'0%';
  // generic fallback using prefix
  const pre=id.split('-')[0]+'-'+id.split('-')[1];
  ['pl','pc','pb'].forEach(suf=>{
    const el=document.getElementById(pre+'-'+suf); if(!el) return;
    if(suf==='pl') el.textContent=lbl;
    if(suf==='pc') el.textContent=`${i}/${tot}`;
    if(suf==='pb') el.style.width=tot?Math.round(i/tot*100)+'%':'0%';
  });
}
function setBusy(id,busy){ const e=document.getElementById(id); if(e){ e.disabled=busy; e.textContent=busy?'Sendingâ€¦':(id==='pay-btn'?'ğŸ“§ Send to All Employees':'ğŸ“¢ Send Broadcast'); } }
function clearAll(){ if(!confirm('Clear ALL data?')) return; emps=[];docs=[];payH=[];bcs=[];acts=[]; save(); refreshAll(); renderRList(); toast('All data cleared'); }

function toast(msg,type){
  const t=document.createElement('div');
  t.className='toast'+(type==='err'?' err':type==='ok'?' ok':'');
  t.textContent=(type==='err'?'âš ï¸ ':type==='ok'?'âœ… ':'')+msg;
  document.getElementById('tw').appendChild(t);
  setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity .4s';setTimeout(()=>t.remove(),400);},4200);
}

// Dept modal trigger fix
document.querySelector('button[onclick="openModal(\'m-dept\')"]')?.removeAttribute('onclick');
document.querySelectorAll('button').forEach(btn=>{
  if(btn.textContent.includes('By Department')) btn.onclick=openDeptModal;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initEJS();
refreshAll();
renderRList();
</script>
</body>
</html>
